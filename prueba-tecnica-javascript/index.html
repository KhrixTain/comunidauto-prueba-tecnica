<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComunidAuto | Prueba técnica</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
</head>
<body>
    <main class="container p-4">
        <header class="mb-3">
            <h1 class="h3">Autos disponibles</h1>
            <p class="text-body-secondary">Filtro de automóviles por marca/modelo. <span class="badge text-bg-success mb-1">Cotización dolar: <span id="dolar-cotizacion"></span></span></p>
        </header>
        <section class="card mb-3">
            <div class="card-body">
                <div class="row g-3 mb-3">
                    <div class="col-12">
                        <label for="marca_modelo_input" class="form-label">Buscar por marca o modelo</label>
                        <input type="search" name="marca_modelo" id="marca_modelo_input" class="form-control" autocomplete="off" spellcheck="false" value="">
                    </div>
                </div>
                <div class="row g-3 mb-3 align-items-end">
                    <p class="col-12 col-md-8">
                        <span id="amount_showing_cars" class="badge rounded-pill text-bg-primary"></span> <span id="text_showing_cars"></span>
                    </p>
                    <div class="col-12 col-md-4">
                        <label for="ordenar_por" class="form-label">Ordenar por</label>
                        <select name="ordenar_por" id="ordenar_por" class="form-select">
                            <option value="precio-menor-mayor" selected>Menor precio</option>
                            <option value="precio-mayor-menor" >Mayor precio</option>
                        </select>
                    </div>
                </div>
                <!-- <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <caption>Listado de vehículos</caption>
                        <thead>
                            <tr>
                                <th class="text-nowrap" scope="col">Marca</th>
                                <th class="text-nowrap" scope="col">Modelo</th>
                                <th class="text-nowrap text-end" scope="col">Precio</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="text-nowrap"></td>
                                <td class="text-nowrap"></td>
                                <td class="text-end text-nowrap"></td>
                            </tr>
                        </tbody>
                    </table>
                </div> -->

            </div>
        </section>
        <section class="card">
            <div class="card-body">
                <ul id="car-list" class="list-group list-group-flush"></ul>
                <div id="sin-resultados" class="alert alert-warning d-none" role="alert">
                    No se han encontrado automóviles.
                </div>
            </div>
        </section>

        <template id="car-item-template">
            <li class="list-group-item list-group-item-action fade" role="listitem">
                <div class="d-flex justify-content-between align-items-start gap-3">
                    <div class="me-auto">
                        <div class="fw-semibold" data-role="brand"></div>
                        <div class="fw-semibold" data-role="model"></div>
                    </div>
                    <div class="text-end">
                        <span class="badge text-bg-primary d-block mb-1" data-role="ars-price"></span>
                        <small class="text-muted">&asymp; <span data-role="usd-price"></span></small>
                    </div>
                </div>
            </li>
        </template>
    </main>
    <script>
        'use strict';

        // =================
        // Datos
        // =================
        const CARS = [
            { id: 1,  marca: 'Chevrolet',  modelo: 'Onix 1.0T LT',       precio: 25560900 },
            { id: 2,  marca: 'Toyota',     modelo: 'Yaris Hatchback XS', precio: 26721000 },
            { id: 3,  marca: 'Fiat',       modelo: 'Cronos 1.3 Like',    precio: 27819000 },
            { id: 4,  marca: 'Peugeot',    modelo: '208 1.6 Active MT',  precio: 28390000 },
            { id: 5,  marca: 'Volkswagen', modelo: 'Polo Track',         precio: 25990000 },
            { id: 6,  marca: 'Renault',    modelo: 'Logan Intens 1.6',   precio: 31200000 },
            { id: 7,  marca: 'Ford',       modelo: 'Ka SE 1.5',          precio: 24500000 },
            { id: 8,  marca: 'Nissan',     modelo: 'Versa Sense MT',     precio: 31450000 },
            { id: 9,  marca: 'Honda',      modelo: 'City LX',            precio: 39800000 },
            { id: 10, marca: 'Chevrolet',  modelo: 'Cruze LT AT',        precio: 45200000 },
            { id: 11, marca: 'Toyota',     modelo: 'Corolla XLI 2.0',    precio: 54500000 },
            { id: 12, marca: 'Citroën',    modelo: 'C3 Live Pack',       precio: 28900000 },
            { id: 13, marca: 'Citroën',    modelo: 'C4 Cactus Feel',     precio: 38900000 },
            { id: 14, marca: 'Peugeot',    modelo: '408 Allure',         precio: 61200000 },
            { id: 15, marca: 'Volkswagen', modelo: 'Vento 1.4 TSI',      precio: 68700000 },
            { id: 16, marca: 'Kia',        modelo: 'Cerato FE 2.0',      precio: 63900000 },
            { id: 17, marca: 'Hyundai',    modelo: 'Accent GLS',         precio: 61500000 },
            { id: 18, marca: 'Chery',      modelo: 'Arrizo 5 Comfort',   precio: 35200000 },
            { id: 19, marca: 'Audi',       modelo: 'A3 35 TFSI',         precio: 145000000 },
            { id: 20, marca: 'BMW',        modelo: '320i SportLine',     precio: 185000000 }
        ];



        // =================
        // Elementos
        // =================

        const carItemTemplate = document.getElementById('car-item-template');
        const carList = document.getElementById('car-list');
        const searchBrandModel = document.getElementById('marca_modelo_input');
        const amountShowingCars = document.getElementById('amount_showing_cars');
        const textShwoingCars = document.getElementById('text_showing_cars');
        const orderBySelector = document.getElementById('ordenar_por');
        const cotizacionDolar = document.getElementById('dolar-cotizacion');
        const noResults = document.getElementById('sin-resultados');

        // =================
        // Configuración
        // =================
        const USD_RATE = 1320;
        const fmtARS = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 });
        const fmtUSD = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'USD', maximumFractionDigits: 0, currencyDisplay: "symbol" });
        const orderStrategies = new Map([
            ['precio-menor-mayor', (current, next) => current.precio - next.precio ],
            ['precio-mayor-menor', (current, next) => next.precio - current.precio ]
        ]);
        
        cotizacionDolar.textContent = fmtARS.format(USD_RATE)

        const STATE = {
            currentOrderStrategy: orderBySelector.value,
            currentQuery: searchBrandModel.value,
            currentCarList: []
        }
        

        // =================
        // Utilidades
        // =================
        const normalize = (str) => {
            return ( str ?? '').toString().trim().toLowerCase().normalize('NFD').replace(/\p{M}/gu, "");
        }

        const isSubstr = (str, substr) => {
            const normalizedSubstr = normalize(substr);
            if(normalizedSubstr.length === 0) return true;
            const normalizedStr = normalize(str);
            return normalizedStr.includes(normalizedSubstr);
        }

        const areCarListsEqualById = (currentCarList, newCarList) => {
            if(STATE.currentCarList.length !== newCarList.length) return false;
            return STATE.currentCarList.every((car, index) => newCarList[index].id === car.id);
        }

        const createCarItem = (car, carItemTemplate) => {
            const clone = carItemTemplate.content.cloneNode(true);
            clone.querySelector('[data-role="brand"]').textContent = car.marca;
            clone.querySelector('[data-role="model"]').textContent = car.modelo;
            clone.querySelector('[data-role="ars-price"]').textContent = fmtARS.format(car.precio);
            clone.querySelector('[data-role="usd-price"]').textContent = fmtUSD.format(car.precio / USD_RATE);
            return clone;
        }

        const renderCarList = (cars) => {
            const out = document.createDocumentFragment();
            cars.map(car => createCarItem(car, carItemTemplate))
                .forEach(carItem => out.appendChild(carItem));
            carList.replaceChildren(out);
            requestAnimationFrame(()=> {
                const items = carList.querySelectorAll('li.fade');
                items.forEach((item, index) => {
                    item.style.transitionDelay = `${index * 0.02}s`; // 20ms por item
                    item.classList.add('show');
                })
            })
        }

        const renderShowInformation = (amount, text) => {
            amountShowingCars.textContent = amount;
            textShwoingCars.textContent = text;
            noResults.classList.toggle('d-none', amount > 0);
        }

        const updateShowInformation = (cars) => {
            const amount = cars.length;
            const text = cars.length === 1 ? 'automóvil se está mostrando' : 'automóviles se están mostrando';
            renderShowInformation(amount, text)
        }

        const carFilter = (cars, query) => {
            return cars.filter(car => isSubstr(car.marca, query) || isSubstr(car.modelo, query));
        }

        const carOrderer = (cars, strategy) => {
            return cars.sort(orderStrategies.get(strategy));
        }

        const updateCarList = (cars) => {
            renderCarList(cars);
            STATE.currentCarList = cars;
        }

        const updateData = (cars) => {
            const filteredCars = carFilter(cars, STATE.currentQuery);
            const orderedCars = carOrderer(filteredCars, STATE.currentOrderStrategy);
            if(!areCarListsEqualById(STATE.currentCarList, orderedCars)) {
                updateCarList(orderedCars);
                updateShowInformation(orderedCars);
            }
        }

        // =================
        // Escuchas
        // =================

        orderBySelector.addEventListener('change', (event) => {
            STATE.currentOrderStrategy = event.currentTarget.value;
            updateData(STATE.currentCarList);
        })
        searchBrandModel.addEventListener('input', (event) => {
            STATE.currentQuery =  event.target.value;
            updateData(CARS);
        })

        updateData(CARS); //estado inicial

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
</body>
</html>